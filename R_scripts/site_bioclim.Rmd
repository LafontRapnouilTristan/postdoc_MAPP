```{r}
EcophyCofog::Library(c("EcophyCofog","readr","dplyr","magrittr","ggplot2","patchwork","ggpubr","tidyr",'Factominer'))
```


# load data

```{r}
data_sat <- read.csv("../ressource/Site_edaphic_data/MappPtsSampled.csv") #site bioclim
load("../output/microeco_obj.Rdata") # metabar datasets
```


```{r}
data_sat %<>%
    mutate(Sample=ifelse(nchar(Sample)<3,paste0("0",Sample),Sample))%>%
    mutate(Sample=ifelse(nchar(Sample)<3,paste0("0",Sample),Sample))%>%
    mutate(Sample=ifelse(grepl("^8",Sample),paste0("0",Sample),Sample))%>% # fix 87a and 87b sample ids
    arrange(Sample)# fix sample ID to match the format of other MAPP datasets
```



# Visualize correlation 

Subset some presumably important covariates

```{r}
var_cor <- GGally::ggpairs(
    data_sat %>% 
        select(c("X","Y","aet_lt","bulk","def_lt","evi_lt","gHM","gpp_lt","height",'lai_lt',"moist_lt","npp_lt","pdsi_lt","pet_lt","ph","pr_lt","ssm_lt","susm_lt","swe_lt","tmmn_lt","tmmx_lt","vap_lt","vpd_lt"))%>%
        mutate(across(.fns = ~replace(., . ==  -9999 , NA))),
    progress = T,
    cardinality_threshold = 105)
ggsave("Figures/cov_cor.png",var_cor,height = 15,width = 15)
```

# PCA on sites

```{r}
PCA_bioclim <- data_sat %>% 
    select(c("X",
             "Y",
             "aet_lt",
             "bulk",
             "srad_lt",
             "def_lt",
             "evi_lt",
             "gHM",
             "gpp_lt",
             "height",
             'lai_lt',
             "moist_lt",
             "npp_lt",
             "pdsi_lt",
             "pet_lt",
             "ph",
             "pr_lt",
             "ssm_lt",
             "susm_lt",
             "swe_lt",
             "tmmn_lt",
             "tmmx_lt",
             "vap_lt",
             "vpd_lt",
             "fpar_lt",
             "soc",
             "water"
             ))%>%
        mutate(across(.fns = ~replace(., . ==  -9999 , NA)))%>%
    FactoMineR::PCA(scale.unit = T,
                    graph = F)
```
```{r}
arrowMul <- function(arrows, data, at = c(0, 0), fill = 0.75) {
  u <- c(range(data[,1], range(data[,2])))
  u <- u - rep(at, each = 2)
  r <- c(range(arrows[, 1], na.rm = TRUE), range(arrows[, 2], na.rm = TRUE))
  rev <- sign(diff(u))[-2]
  if (rev[1] < 0)
    u[1:2] <- u[2:1]
  if (rev[2] < 0)
    u[3:4] <- u[4:3]
  u <- u/r
  u <- u[is.finite(u) & u > 0]
  fill * min(u)
}
```

```{r}
eig <- PCA_bioclim$eig
coord_pca <- as.data.frame(PCA_bioclim$ind$coord)
coord_pca$site <- data_sat$Sample

mul <- arrowMul(as.data.frame(PCA_bioclim$var$coord),
               coord_pca)

pca_site_biplot <- ggplot(coord_pca,aes(x=Dim.1,y=Dim.2))+
    geom_point(color="orange")+
    theme_classic2()+
    geom_vline(xintercept = 0,lty=2)+
    geom_hline(yintercept = 0,lty=2)+
    # ggrepel::geom_label_repel(data=filter(coord_pca,Dim.2< -3),aes(x=Dim.1,y=Dim.2,label=site))+
    xlab(paste0("PC1 (",round(eig[1,2],2),"%)"))+
    ylab(paste0("PC2 (",round(eig[2,2],2),"%)"))+
    geom_segment(data= as.data.frame(PCA_bioclim$var$coord),aes(x = 0, y = 0, xend=mul*Dim.1, yend=mul*Dim.2),
               lineend = "round", 
               linejoin = "round",
               linewidth = .75, 
               arrow = arrow(length = unit(0.2, "inches")),
               colour = "black" 
  )+
    ggrepel::geom_text_repel(data = data.frame(var=rownames(PCA_bioclim$var$coord),PCA_bioclim$var$coord*mul), # add variable names at the end of arrows
            aes(x = ifelse(Dim.1<0,Dim.1*1.1,Dim.1*1.1), # nudge a bit the coordinates so that they're not on the arrows
                y = ifelse(Dim.2<0,Dim.2*1.1,Dim.2*1.1),
                label = var),
             max.overlaps = getOption("ggrepel.max.overlaps", default = 15))+
    ggtitle("Biplot sites long term")+
    theme(plot.title = element_text(face="bold"))
ggsave(pca_site_biplot,filename="../Figures/PCA_sites.png")
    
```





